generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- Tenant & Branding ---

model Tenant {
  id        String   @id @default(uuid())
  name      String
  domain    String   @unique @default("alma.agency") // Default for migration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branding
  logoDarkHorizontalUrl  String?
  logoDarkVerticalUrl    String?
  logoLightHorizontalUrl String?
  logoLightVerticalUrl   String?
  primaryColor           String  @default("#000000")
  backgroundDark         String  @default("#000000")
  backgroundLight        String  @default("#FFFFFF")
  accentColor            String  @default("#FFFFFF")
  textOnDark             String  @default("#FFFFFF")
  textOnLight            String  @default("#111111")

  // Relations
  users            User[]
  teams            Team[]
  companies        Company[]
  contacts         Contact[]
  leads            Lead[]
  deals            Deal[]
  clientAccounts   ClientAccount[]
  contracts        Contract[]
  pipelines        Pipeline[]
  activities       Activity[]
  messages         Message[]
  conversations    Conversation[]
  channelAccounts  ChannelAccount[]
  leadSources      LeadSource[]
  auditLogs        AuditLog[]
  serviceSubscriptions ServiceSubscription[]
  mrrRecords       MRRRecord[]
  briefings        Briefing[]
}

// --- User Management ---

model User {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  email     String   @unique
  password  String   @default("$2a$10$EpWaTgiFbI.w.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1") // Default hash for "123456" (placeholder)
  role      String   @default("SALES_REP") // Enum handled in app logic or simple string for SQLite
  createdAt DateTime @default(now())

  // Relations
  teams              TeamMember[]
  ownedLeads         Lead[]
  ownedDeals         Deal[]
  managedAccounts    ClientAccount[]
  activities         Activity[]
  sentMessages       Message[]
  assignedConversations Conversation[]
  auditLogs          AuditLog[]
}

model Team {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  type      String   // Enum handled in app

  members   TeamMember[]
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id])
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

// --- CRM Core ---

model Company {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  segment   String?
  size      String?
  website   String?
  origin    String?
  tags      String // Stored as JSON string or comma-separated
  createdAt DateTime @default(now())

  contacts       Contact[]
  leads          Lead[]
  deals          Deal[]
  clientAccounts ClientAccount[]
  conversations  Conversation[]
}

model Contact {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  name        String
  jobTitle    String?
  mainChannel String?
  phones      String // JSON string
  emails      String // JSON string
  socialProfiles String // JSON string

  leads         Lead[]
  deals         Deal[]
  conversations Conversation[]
  messages      Message[]
}

// --- Sales Pipeline ---

model Lead {
  id               String         @id @default(uuid())
  tenantId         String
  tenant           Tenant         @relation(fields: [tenantId], references: [id])
  companyId        String?
  company          Company?       @relation(fields: [companyId], references: [id])
  primaryContactId String?
  primaryContact   Contact?       @relation(fields: [primaryContactId], references: [id])
  ownerId          String?
  owner            User?          @relation(fields: [ownerId], references: [id])
  
  status           String     @default("OPEN")
  sourceType       String
  campaignId       String?
  campaign         LeadSource?    @relation(fields: [campaignId], references: [id])
  
  // Qualification
  budgetRange      String?
  urgency          String?
  serviceType      String?
  fitScore         Int?
  leadScore        Int            @default(0)

  createdAt        DateTime       @default(now())

  deals            Deal[]
  activities       Activity[]
  briefings        Briefing[]
  messages         Message[]
}

model Deal {
  id               String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  
  leadId           String?
  lead             Lead?    @relation(fields: [leadId], references: [id])
  companyId        String?
  company          Company? @relation(fields: [companyId], references: [id])
  primaryContactId String?
  primaryContact   Contact? @relation(fields: [primaryContactId], references: [id])
  ownerId          String?
  owner            User?    @relation(fields: [ownerId], references: [id])

  pipelineId       String
  pipeline         Pipeline @relation(fields: [pipelineId], references: [id])
  stageId          String
  stage            Stage    @relation(fields: [stageId], references: [id])

  title            String
  expectedMRR      Decimal?
  expectedOneOff   Decimal?
  probability      Int?
  expectedCloseDate DateTime?
  
  status           String @default("OPEN")
  lostReason       String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  contract         Contract?
  briefing         Briefing?
  activities       Activity[]
  messages         Message[]
  conversations    Conversation[]
}

model Pipeline {
  id       String   @id @default(uuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  name     String
  type     String
  stages   Stage[]
  deals    Deal[]
}

model Stage {
  id                 String   @id @default(uuid())
  pipelineId         String
  pipeline           Pipeline @relation(fields: [pipelineId], references: [id])
  name               String
  orderIndex         Int
  defaultProbability Int?
  deals              Deal[]
}

// --- Post-Sales & Finance ---

model ClientAccount {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  csOwnerId     String?
  csOwner       User?    @relation(fields: [csOwnerId], references: [id])

  status        String   @default("ACTIVE")
  healthScore   Int          @default(100)
  healthBand    String   @default("GREEN")
  currentMRR    Decimal      @default(0)

  services      ServiceSubscription[]
  contracts     Contract[]
  mrrRecords    MRRRecord[]
  activities    Activity[]
  messages      Message[]
}

model Contract {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  clientAccountId String
  clientAccount   ClientAccount @relation(fields: [clientAccountId], references: [id])
  dealId          String?  @unique
  deal            Deal?    @relation(fields: [dealId], references: [id])

  type            String
  startDate       DateTime
  endDate         DateTime?
  renewalType     String
  renewalNoticeDays Int?
  
  baseMRR         Decimal
  setupFee        Decimal?
  
  status          String @default("ACTIVE")
  externalId      String?
}

model ServiceSubscription {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  clientAccountId String
  clientAccount   ClientAccount @relation(fields: [clientAccountId], references: [id])
  
  serviceType     String
  monthlyFee      Decimal
  adSpendResponsibility String
  status          String @default("ACTIVE")
}

model MRRRecord {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  clientAccountId String
  clientAccount   ClientAccount @relation(fields: [clientAccountId], references: [id])
  
  month           DateTime
  amount          Decimal
  deltaType       String
}

// --- Inbox & Communication ---

model Conversation {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id])
  
  channelType     String
  status          String @default("OPEN")
  unreadCount     Int      @default(0)
  lastMessageAt   DateTime @default(now())
  
  assignedToId    String?
  assignedTo      User?    @relation(fields: [assignedToId], references: [id])
  
  linkedDealId    String?
  linkedDeal      Deal?    @relation(fields: [linkedDealId], references: [id])

  messages        Message[]
}

model Message {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  
  channelType     String
  direction       String
  
  senderId        String?
  sender          User?   @relation(fields: [senderId], references: [id])
  
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  
  content         String
  mediaUrl        String?
  mediaType       String?
  
  timestamp       DateTime @default(now())
  
  // Linking
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id])
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  clientAccountId String?
  clientAccount   ClientAccount? @relation(fields: [clientAccountId], references: [id])
}

model ChannelAccount {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  type        String
  displayName String
  status      String
  credentials String? // JSON string
}

// --- Activities & Misc ---

model Activity {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  type            String
  description     String
  status          String @default("OPEN")
  dueDate         DateTime?
  
  ownerId         String
  owner           User     @relation(fields: [ownerId], references: [id])
  
  // Polymorphic-ish relations
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id])
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  clientAccountId String?
  clientAccount   ClientAccount? @relation(fields: [clientAccountId], references: [id])
  
  createdAt       DateTime @default(now())
}

model Briefing {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  leadId    String?
  lead      Lead?    @relation(fields: [leadId], references: [id])
  dealId    String?  @unique
  deal      Deal?    @relation(fields: [dealId], references: [id])
  
  status    String @default("DRAFT")
  answers   String // JSON string
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LeadSource {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  name       String
  type       String
  platform   String?
  leads      Lead[]
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  actorId    String
  actor      User     @relation(fields: [actorId], references: [id])
  action     String
  entityType String
  entityId   String
  details    String? // JSON string
  timestamp  DateTime @default(now())
}
